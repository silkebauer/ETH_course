# Exercise: Survival estimation {#exSurvest}


## Introduction to mark-recapture modelling

Recapture or resightings (reencounters) of marked individuals inform about apparent survival, i.e. the probability that an individual survives and stays in the study area. Apparent survival differs from true survival because when the animals is seen last, it is still alive, i.e. the death is not observed. Thus, if an animal is no longer recaptured or resighted, we do not know whether it moved out of the study area or whether it died. Mark-recapture modelling techniques are designed to separately estimate recapture/resighting probability and apparent survival. To do so, they separate the observation process (recapturing or resighting an animal) from the biological process (staying in the study area and surviving). The basis for the development of an immense diversity of mark-recapture models has been set by the Cormack-Jolly-Seber model [@Cormack.1964; @Jolly.1965; @Seber.1965]. The CJS-model is introduced here using data on Snowfinches, a high alpine bird species that we study since 2015. 

```{r readdat}
load("data/annualCRdata.rda") # load datax object
```

Since 2015, we individually marked `r datax$nind` Snowfinches. We systematically observed Snowfinches to read rings using scopes and cameras. We could resight `r sum(apply(datax$y, 1, sum)>1)` of the marked individuals in later years, many of them in more than one year. We collated the marking and resighting data in a capture history matrix $y$. Each row of $y$ contains the capture history of one individual and each column corresponds to a year from 2015 to 2023. A $1$ indicates that the individual was resighted or recaptured during that year and a $0$ indicates that the individual has not been seen. Thus, a $1$ means the individual is alive in the study area and it has been detected by the researchers. A $0$ could mean that the individual died, that it emigrated from the study area or that it is still alive in the study area but has not been detected by the researchers. 

```{r seedat, fig.cap="Visualisation of the capture-recapture/resighting data. Each horizontal line connect capture or resightings of the same individual, a circle indicate that the individual is captured or resighted at least once during that year."}
index <- order(datax$first)
ch <- datax$y[index,]
plot(c(1,datax$nocc), c(1, datax$nind), type="n", axes=FALSE, xlab="Yeaer", ylab="Individual")
axis(1, at=1:datax$nocc)
axis(2, at=1:datax$nind, las=1, cex.lab=0.5)
for(i in 1:datax$nind){
  points(c(1:datax$nocc)[ch[i,]==1], rep(i,sum(ch[i,])), cex=.6) 
  lines(c(1:datax$nocc)[ch[i,]==1], rep(i,sum(ch[i,])))
}

```


Model description:  

The observations $y_{it}$, an indicator of whether individual $i$ was recaptured or resighted during year $t$ is modeled conditional on the latent true state of the individual birds $z_{it}$ (0 = dead or permanently emigrated, 1 = alive and at the study site) as a Bernoulli variable. The probability $P(y_{it} = 1)$ is the product of the probability that an alive individual is recaptured or resighted, $p_{it}$, and the state of the bird $z_{it}$ (alive = 1, dead = 0). Thus, a dead bird cannot be recaptured or resighted, whereas for a bird alive during year $t$, the recapture/resighting probability equals $p_{it}$:
$$y_{it} \sim Bernoulli(z_{it}p_{it})$$
The latent state variable $z_{it}$ is a Markovian variable with the state at year $t$ being dependent on the state at year $t-1$ and the apparent survival probability $\phi_{it}$:
$$z_{it} \sim Bernoulli(z_{it-1}\phi_{it})$$

We use the notation $\phi$ to indicate that this parameter can be interpreted as apparent survival rather than true survival of which the standard notation would be $S$ [@Thomson.2009d]. 
We model $\phi$ dependent on age (1=first year, 2=older) and year.

$$\phi_{it} = \alpha_{age-class[it], t} $$

Annual recapture/resighting probability is modeled for each year independently:
$$p_{it} = \beta_{t}$$
We use uniform prior distributions for all parameters with a parameter space limited to values between 0 and 1 (probabilities), $\alpha_{age-class,t} \sim uniform(0,1)$ and $\beta_t \sim uniform(0,1)$.

We use Markov chain Monte Carlo simulations as implemented in jags [@Plummer2003] to fit the model to the data. For doing so, we first need to specify the model using Jags language. We do that in a separate text-file (jags/cjs.txt). 

To fit the model, the [Software jags](https://sourceforge.net/projects/mcmc-jags/files/) need to be downloaded and installed. 

```{r, echo=FALSE}
cat("## jags model code
model{
  ## likelihood
  for(i in 1:nind){
    z[i,first[i]]  <- 1
    for(t in (first[i]+1):nocc) {
      phiz[i, t-1] <- z[i,t-1]*phi[i, t-1]
      z[i,t] ~ dbern(phiz[i, t-1])
      zp[i,t] <- z[i,t]*p[i,t-1]
      y[i,t] ~ dbern(zp[i,t])
    }
  }

  ## linear predictors
  for(i in 1:nind){
    for(t in first[i]:(nocc-1)){
      phi[i,t] <-  a[age[i,t],t]
      p[i,t] <-  b[t]
    }
  }

  ## priors
 for(t in 1:(nocc-1)){
  b[t] ~ dunif(0, 1)
  a[1,t] ~ dunif(0, 1)
  a[2,t] ~ dunif(0, 1)

 }
}")
```

After having specified the model, we need to bundle the data into a list. We have prepared that list in the object `datax`.


```{r lookatdata, collapse=TRUE}
str(datax)

```

We then need to specify initial values and the parameters that we would like to save. 

```{r jagsfit, eval=FALSE}
library(R2jags)
initz <- matrix(NA, ncol=datax$nocc, nrow=datax$nind)
for(i in 1:datax$nind) initz[i,(datax$first[i]+1):datax$nocc] <- 1
initfun <- function(){
  list(a=matrix(runif(2*(datax$nocc-1), 0,1), ncol=datax$nocc-1, nrow=2),
       b=runif(datax$nocc-1, 0,1),
       z=initz)
}


parameters <- c("a", "b")
mod <- jags(datax, inits=initfun, parameters.to.save=parameters, 
            model.file="jags/cjs.txt", n.chains=3, n.iter=2000)
mod <- mod$BUGSoutput
save(mod, file="modelfits/survivalmodel.rda")

```

Before we look at the results, we check how well the Markov chains converged. The chains look ok except for the parameters of the last year. For the last year, apparent survival cannot be separated from recapture/resighting probability. Thus, we must expect that these chains do not converge well.  

```{r, eval=FALSE}
# check 
traceplot(mod)

```
In the Cormack-Jolly-Seber model, for the last occasion, only the product of survival and recapture probability is estimable. Therefore, for these two parameters, it does not look like the Markov chains have converged.  

We then look at the results


```{r, collapse=TRUE}
load("modelfits/survivalmodel.rda")
mod$summary

```



```{r, fig.asp=0.55, fig.cap="Annual apparent survival of juvenile and adult Snowfinches."}

plot(c(2015,2023), c(0,1), type="n", las=1, xlab=NA, ylab="Apparent survival")

phi <- apply(mod$sims.list$a, c(2,3), mean)
phi.lwr <- apply(mod$sims.list$a, c(2,3), quantile, probs=0.025)
phi.upr <- apply(mod$sims.list$a, c(2,3), quantile, probs=0.975)
x <- seq(2015.5, 2022.5, by=1)
segments(x, phi.lwr[1,], x,phi.upr[1,])
points(x, phi[1,], pch=21, bg="white")
segments(x+0.1, phi.lwr[2,], x+0.1,phi.upr[2,], lwd=2, col="brown")
points(x+0.1, phi[2,], pch=21, bg="white", col="brown")
legend(2015, 1.1, xpd=NA, lwd=c(1,2), col=c(1,"brown"), legend=c("first year", "adult"), horiz=TRUE)

```


```{r, fig.asp=0.5, fig.cap="Recapture and resighting probability"}

plot(c(2016,2023), c(0,1), type="n", las=1, xlab=NA, ylab="Recapture/resighting probability")

p <- apply(mod$sims.list$b, 2, mean)
p.lwr <- apply(mod$sims.list$b, 2, quantile, probs=0.025)
p.upr <- apply(mod$sims.list$b, 2, quantile, probs=0.975)
x <- seq(2016, 2023, by=1)
segments(x, p.lwr, x,p.upr, lwd=2, col="brown")
points(x, p, pch=21, bg="white", col="brown")

```

@Kery.2012 wrote a gentle introduction to mark-recapture modelling for biologists. An example using Stan is found here https://tobiasroth.github.io/BDAEcology/cjs_with_mix.html.


